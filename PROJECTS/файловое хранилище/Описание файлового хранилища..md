Ниже приведено описание работы файлового хранилища в ERP-системе с использованием представленных таблиц:

1. **Физическое хранение и версия файлов**
    
    - **FileNodes:** Каждый физически сохранённый файл получает уникальный идентификатор (номер), который записывается в таблице FileNodes вместо обычного имени. Здесь хранится:
        - Ссылка на сервер/хранилище, где расположен файл.
        - Контрольная сумма файла для обнаружения дублей и проверки целостности.
        - Хеш файла, который может использоваться для проверки подписи.
    - **FileNodeLog:** При каждом изменении файла создаётся запись в таблице FileNodeLog, фиксирующая данные (например, дату изменения, пользователя и путь, откуда был произведён доступ). Таким образом, поддерживается история версий каждого файла.
2. **Отображение актуальной версии файла в системе**
    
    - **FileList:** Для каждого файла, который отображается в системе, хранится запись в таблице FileList. Здесь:
        - Сохраняется ссылка на актуальный FileNode, который соответствует последней версии файла.
        - Возможна «мягкая ссылка» — файл может ссылаться сам на себя (поле SoftLinkFileID), что позволяет создавать альтернативные представления или ссылки на один и тот же физический файл.
        - Каждая запись связывается с элементом каталога (из таблицы Catalogs), что позволяет организовать файлы в древовидные структуры.
3. **Организация файлов в каталоги (деревовидная структура)**
    
    - **Catalogs:** Таблица Catalogs представляет базу для организации файлов в виде дерева. Один файл может находиться в нескольких таких структурах, поскольку:
        - Структуры могут быть различными (определяются полем CatalogType).
        - Файл в FileList ссылается на нужный каталог, что позволяет избежать дублирования и при этом сохранить общую историю файла.
4. **Хранение на различных типах серверов**
    
    - **FileStorage:** Файлы могут храниться на серверах, использующих различные протоколы (например, SFTP, S3, NFS, SMB). Таблица FileStorage содержит данные доступа и параметры каждого хранилища (адрес сервера, порт, учётные данные, тип хранилища и т.п.).
    - **FileStorageDefs:** Если система использует несколько хранилищ, к определённому каталогу можно привязать своё хранилище. Для этого используется таблица FileStorageDefs, связывающая каталоги с конкретными хранилищами.
5. **Способы добавления файлов**  
    В приложении реализованы два сценария добавления файла:
    
    - **Привязка к объекту:** Файл добавляется к конкретному объекту ERP-системы. Связь между файлом и объектом хранится в таблице FileLinks. Один файл может быть привязан к разным объектам – это позволяет, например, выбирать уже существующий файл из «файлового браузера» при редактировании объекта.
    - **Загрузка в определённую папку:** Файл можно загрузить в конкретный каталог (папку). Если известно, где должен отображаться файл, для этого предусмотрены настройки по умолчанию. В таблице FileLinkDefaults хранятся настройки, связывающие тип объекта с соответствующим каталогом.
6. **Обработка дублей**
    
    - При добавлении файла система рассчитывает его контрольную сумму. Если обнаруживается, что файл с такой контрольной суммой уже существует в системе, пользователю предлагается создать ссылку (то есть привязку к существующему FileNode), а не сохранять физически идентичный файл заново. Это позволяет экономить место и сохранять единую историю изменений.
7. **Подпись файлов**
    
    - **Внешняя подпись:** Файл может быть подписан вне системы (подписывающий файл добавляется в систему отдельно).
    - **Встроенная подпись:** В приложении пользователь может создать пару ключей. Его публичный ключ сохраняется в системе (таблица UserPublicKeys), а подписи, связанные с файлом, записываются в таблице FileSignatures. При этом подпись ссылается на FileNode, пользователя и, при необходимости, на конкретный публичный ключ.
8. **Дополнительная функциональность: Теги и блокировка**
    
    - **Теги:** Для расширенного поиска к файлам можно прикреплять теги. Сами теги хранятся в таблице TagList, а связь между файлами и тегами – в таблице FileListTags.
    - **Блокировка:** Для предотвращения конфликтов при одновременном редактировании файла используется механизм блокировки (таблица FileLock), где фиксируется, какой пользователь в данный момент заблокировал файл для редактирования.
    - 
  9 . **Особенности работы с файловым архивом SMB**

- **Имя файла в системе хранения:**  
    В таблице **FileNodes** поле **NodeName** хранит имя файла, которое формируется как GUID на стороне сервера. Это имя используется как уникальный идентификатор физически сохранённого объекта.
    
- **Формирование пути при использовании файловой системы (SMB):**  
    Если для хранения файлов выбрана файловая система (SMB), путь до файла формируется автоматически по следующей схеме:
    
    - **Имя сервера:** используется в качестве начальной части пути.
    - **Путь до архива:** задаётся в настройках хранилища.
    - **Автоматически сформированный путь на основе GUID:**
        - Первые два символа GUID используются для формирования вложенных папок (например, первая подпапка – из первого символа, вторая – из второго).
        - Дополнительно создаётся подпапка, определяемая третьим символом GUID.
    
    Такой механизм распределения позволяет равномерно хранить более 1 000 000 файлов, предотвращая перегрузку отдельных каталогов и обеспечивая эффективное управление файловой системой.
    
- **Использование объектного хранилища:**  
    Если выбран вариант объектного хранилища, в настройках указывается путь к корзине (bucket) для хранения файлов. В этом случае схема формирования пути отличается от файловой системы, и используется логика, присущая выбранному объектному хранилищу.